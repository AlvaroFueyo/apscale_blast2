Metadata-Version: 2.4
Name: apscale-blast2
Version: 1.0.0
Summary: APSCALE-like BLAST with per-FASTA DB selection, APSCALE flags, taxonomy cleaning, tqdm progress, Python 3.13 compatible.
Author: You
License: MIT
Requires-Python: >=3.10
Description-Content-Type: text/markdown
License-File: LICENSE
Requires-Dist: pandas>=2.0
Requires-Dist: openpyxl>=3.1
Requires-Dist: pyarrow>=12
Requires-Dist: tqdm>=4.66
Dynamic: license-file

# apscale_blast2 (v1.0.0)

`apscale_blast2` is a local BLAST-based taxonomic assignment tool inspired by **apscale_blast**.
It preserves the APSCALE-style assignment logic (mode-1 hit selection and F1–F4 flags) while adding
an interactive wizard and built-in database management.

## Project overview

Typical use case: metabarcoding / biomonitoring workflows where you want to run local BLAST against
curated reference databases and obtain both **raw BLAST hits** and **taxonomy-aware assignments**.

## Key features

- **Interactive wizard (default)**: select a folder of FASTA files and choose a database per FASTA.
- **CLI mode** for scripted / pipeline execution.
- **Local database store** (per-user) so you do not need to pass database paths every time:
  - environment variable: `APSCALE_BLAST2_DB_HOME`
  - CLI argument: `--db-home`
- **Database recipes** (build & install from the wizard):
  - MIDORI2
  - UNITE
  - SILVA
  - PR2
  - trnL
  - DiatBarcode
- **APSCALE-like assignment logic**
  - **Mode 1** (Similarity → E-value) hit selection before flags
  - F1–F4 flags and similarity-threshold trimming

## Requirements

- Python **>= 3.10**
- **NCBI BLAST+ >= 2.17.0** in the Path (hard requirement). The program checks this at startup.

## Installation

From the repository root:

```bash
python -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\Activate.ps1
pip install -U pip
pip install -e .
```

## Quick start (wizard mode)

Run:

```bash
apscale_blast2
```

You will be prompted to:

1. Select a folder containing `.fa/.fasta/.fna` files (non-recursive).
2. For each FASTA, choose:
   - **Build and install a new database (recipe)**, or
   - Select an existing installed database, or
   - **Skip** the FASTA.

The wizard asks once for the BLAST search mode:
- `megablast` (default; faster; good for similar amplicons/barcodes)
- `blastn` (more sensitive; slower)

## CLI usage (non-interactive)

Run the same workflow without prompts by specifying inputs:

```bash
apscale_blast2 --fastas /path/to/fastas --db-for-all /path/to/db_folder --threads 8
```

Or provide a CSV mapping FASTA basenames to database folders:

```bash
apscale_blast2 --fastas /path/to/fastas --db-map mapping.csv
```

## Outputs

For each input FASTA, the tool writes:

- `raw_blast/<sample>_raw_blast.xlsx` — merged BLAST outfmt6 hits
- `taxonomy/<sample>_taxonomy.xlsx` — taxonomy-aware assignments after filtering/flags

Temporary subset FASTA files are created under a run directory and removed by default.

## Performance notes

- The tool applies early BLAST-side filters for speed:
  - `-evalue` (defaults to `1e-3`)
  - `-qcov_hsp_perc` (defaults to `50`)
- Additional **soft** query-coverage preference is applied in Python:
  - if any hit has `qcov >= 90%`, only those hits are considered
  - otherwise, the tool falls back to all hits (to avoid losing assignments)

### About `-max_target_seqs`

The default is `--max-target-seqs 20`. BLAST breaks ties by database order, which can affect the
top-N set in edge cases. A future update may evaluate increasing this default (e.g., 40) to improve
robustness with large databases.

## How this fork differs from apscale_blast

This project is intended as a fork/upgrade of the original `apscale_blast`.

**Preserved behaviour**
- APSCALE-like thresholds and flags (F1–F4)
- Mode-1 ranking (Similarity → E-value) before flagging

**New / changed behaviour**
- Local-only BLAST execution (no web/remote BLAST mode)
- Interactive wizard for per-FASTA database selection
- Integrated database building via recipes (MIDORI2, UNITE, SILVA, PR2, trnL, DiatBarcode)
- Per-user database home (no repeated path prompts)
- BLAST+ >= 2.17.0 enforced for consistent database building and execution

## License

MIT (see `LICENSE`).
